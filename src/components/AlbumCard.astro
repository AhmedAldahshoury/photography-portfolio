---
import { cfImageUrl } from '../utils/cfImages';

const { album } = Astro.props;
const albumDate = album.date ? new Date(album.date) : null;
const yearLabel = albumDate ? albumDate.getUTCFullYear() : 'Album';
const toTitleCase = (value) =>
  value
    ?.split(' ')
    .filter(Boolean)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');

const normalizedTitle = album.title?.replace(/^\d{4}[\s_-]?\d{2}[\s_-]?\d{2}\s*/, '').trim();
const slugLocation = album.slug?.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/[-_]/g, ' ');
const titleLocation = normalizedTitle || slugLocation;
const location = titleLocation || album.slug?.split('-').slice(3).join(' ');
const locationLabel = location
  ? toTitleCase(location)
  : 'Signature Series';
const albumTitle = locationLabel || 'Signature Series';
const imageCount = album.imageKeys?.length ?? 0;
const frameLabel = imageCount ? `${imageCount} frame${imageCount === 1 ? '' : 's'}` : 'Gallery';
const hashSeed = (input) =>
  Array.from(input ?? '').reduce((acc, char) => acc + char.charCodeAt(0), 0);
const seed = hashSeed(album.slug || album.title || album.coverKey || '');
const toneOptions = ['luminous', 'moody', 'sunlit', 'nocturnal', 'softly lit', 'atmospheric'];
const focusOptions = ['textures', 'architecture', 'portraits', 'landscapes', 'details', 'ritual'];
const paletteOptions = ['warm neutrals', 'deep shadows', 'muted blues', 'golden tones', 'silvery highlights', 'earthy hues'];
const tone = toneOptions[seed % toneOptions.length];
const focus = focusOptions[(seed + 3) % focusOptions.length];
const palette = paletteOptions[(seed + 7) % paletteOptions.length];
const albumDescription =
  album.description ??
  `A ${tone} study of ${albumTitle} highlighting ${focus} with ${palette}.`;
---

<a class="card" href={`/albums/${album.slug}`}>
  <img
    class="card-image"
    src={cfImageUrl(album.coverKey, { width: 700, quality: 75 })}
    alt={`${albumTitle} cover`}
    loading="lazy"
    decoding="async"
    width="700"
    height="467"
  />
  <div class="card-body">
    <div class="badge">{yearLabel}</div>
    <h3 style="margin-top: 0.75rem;">{albumTitle}</h3>
    <p style="color: var(--muted); margin-top: 0.5rem;">{albumDescription}</p>
    <p style="color: var(--muted); margin-top: 0.75rem; font-size: 0.9rem;">
      {locationLabel} Â· {frameLabel}
    </p>
    {albumDate && (
      <p style="color: var(--muted); margin-top: 0.5rem;">
        {albumDate.toLocaleDateString('en-US', { month: 'long', day: '2-digit', year: 'numeric', timeZone: 'UTC' })}
      </p>
    )}
  </div>
</a>
