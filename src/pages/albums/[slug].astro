---
import BaseLayout from '../../layouts/BaseLayout.astro';
import albums from '../../data/albums.generated.json';
import { cfImageUrl } from '../../utils/cfImages';

export function getStaticPaths() {
  return albums.map((album) => ({
    params: { slug: album.slug },
    props: { album },
  }));
}

const { album } = Astro.props;
const albumDate = album.date ? new Date(album.date) : null;
const formattedDate = albumDate
  ? albumDate.toLocaleDateString('en-US', { month: 'long', day: '2-digit', year: 'numeric', timeZone: 'UTC' })
  : null;
const titleLocation = album.title?.split('—')[0]?.trim();
const location = titleLocation || album.slug?.split('-').slice(3).join(' ');
const locationLabel = location
  ? location.replace(/\b\w/g, (char) => char.toUpperCase())
  : 'T7TFOS';
const imageCount = album.imageKeys?.length ?? 0;
const frameLabel = imageCount ? `${imageCount} frame${imageCount === 1 ? '' : 's'}` : 'Gallery';
const metaDescription = album.description
  ? album.description
  : albumDate
    ? `${album.title} captured on ${formattedDate} in ${locationLabel}, featuring ${frameLabel}.`
    : `Photography album ${album.title} in ${locationLabel}, featuring ${frameLabel}.`;
---

<BaseLayout
  title={`${album.title} — T7TFOS Photography`}
  description={metaDescription}
>
  <section class="section">
    <div class="container">
      <div class="album-hero">
        <div>
          <span class="badge">{formattedDate ?? 'Signature Series'}</span>
          <h1 class="section-title" style="margin-top: 1rem;">{album.title}</h1>
          <p class="section-subtitle" style="margin-top: 1rem;">
            {locationLabel} · {frameLabel}
          </p>
          {album.description && (
            <p style="margin-top: 1.5rem; color: var(--muted); max-width: 40rem;">
              {album.description}
            </p>
          )}
          {albumDate && (
            <p style="margin-top: 1.5rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.2em;">
              {albumDate.getUTCFullYear()}
            </p>
          )}
        </div>
        <img
          src={cfImageUrl(album.coverKey, { width: 1400, quality: 80 })}
          alt={`${album.title} cover`}
          loading="eager"
          decoding="async"
          fetchpriority="high"
          width="1400"
          height="933"
        />
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <!-- Responsive image grid with click-to-open lightbox -->
      <div class="image-grid">
        {album.imageKeys.map((image, index) => (
          <button
            type="button"
            data-lightbox-src={cfImageUrl(image, { width: 2000, quality: 82 })}
            aria-label={`Open image ${index + 1}`}
          >
            <img
              src={cfImageUrl(image, { width: 900, quality: 78 })}
              alt={`${album.title} image ${index + 1}`}
              loading="lazy"
              decoding="async"
              width="900"
              height="600"
            />
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Lightweight lightbox overlay (no external libraries) -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lightbox-content">
      <button type="button" id="lightbox-close">Close</button>
      <div class="lightbox-image-frame">
        <img
          id="lightbox-image"
          src=""
          alt="Expanded view"
          loading="lazy"
          decoding="async"
          width="2000"
          height="1333"
        />
      </div>
    </div>
  </div>

  <script is:inline>
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const closeButton = document.getElementById('lightbox-close');

    const openLightbox = (src) => {
      lightboxImage.src = src;
      lightbox.classList.add('is-open');
      lightbox.setAttribute('aria-hidden', 'false');
    };

    const closeLightbox = () => {
      lightbox.classList.remove('is-open');
      lightbox.setAttribute('aria-hidden', 'true');
      lightboxImage.src = '';
    };

    document.querySelectorAll('[data-lightbox-src]').forEach((button) => {
      button.addEventListener('click', () => {
        openLightbox(button.dataset.lightboxSrc);
      });
    });

    closeButton.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (event) => {
      if (event.target === lightbox) {
        closeLightbox();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeLightbox();
      }
    });
  </script>
</BaseLayout>
