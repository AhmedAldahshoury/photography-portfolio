---
import BaseLayout from '../../layouts/BaseLayout.astro';
import albums from '../../data/albums.generated.json';
import { cfImageUrl } from '../../utils/cfImages';

export function getStaticPaths() {
  return albums.map((album) => ({
    params: { slug: album.slug },
    props: { album },
  }));
}

const { album } = Astro.props;
const albumDate = album.date ? new Date(album.date) : null;
const formattedDate = albumDate
  ? albumDate.toLocaleDateString('en-US', { month: 'long', day: '2-digit', year: 'numeric', timeZone: 'UTC' })
  : null;
const toTitleCase = (value) =>
  value
    ?.split(' ')
    .filter(Boolean)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');

const normalizedTitle = album.title?.replace(/^\d{4}[\s_-]?\d{2}[\s_-]?\d{2}\s*/, '').trim();
const slugLocation = album.slug?.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/[-_]/g, ' ');
const titleLocation = normalizedTitle || slugLocation;
const location = titleLocation || album.slug?.split('-').slice(3).join(' ');
const locationLabel = location
  ? toTitleCase(location)
  : 'T7TFOS';
const albumTitle = locationLabel || 'Signature Series';
const imageCount = album.imageKeys?.length ?? 0;
const frameLabel = imageCount ? `${imageCount} frame${imageCount === 1 ? '' : 's'}` : 'Gallery';
const hashSeed = (input) =>
  Array.from(input ?? '').reduce((acc, char) => acc + char.charCodeAt(0), 0);
const seed = hashSeed(album.slug || album.title || album.coverKey || '');
const toneOptions = ['luminous', 'moody', 'sunlit', 'nocturnal', 'softly lit', 'atmospheric'];
const focusOptions = ['textures', 'architecture', 'portraits', 'landscapes', 'details', 'ritual'];
const paletteOptions = ['warm neutrals', 'deep shadows', 'muted blues', 'golden tones', 'silvery highlights', 'earthy hues'];
const tone = toneOptions[seed % toneOptions.length];
const focus = focusOptions[(seed + 3) % focusOptions.length];
const palette = paletteOptions[(seed + 7) % paletteOptions.length];
const albumDescription =
  album.description ??
  `A ${tone} study of ${albumTitle} highlighting ${focus} with ${palette}.`;
const metaDescription = albumDescription ?? (albumDate
  ? `${albumTitle} captured on ${formattedDate} in ${locationLabel}, featuring ${frameLabel}.`
  : `Photography album ${albumTitle} in ${locationLabel}, featuring ${frameLabel}.`);
---

<BaseLayout
  title={`${albumTitle} — T7TFOS Photography`}
  description={metaDescription}
>
  <section class="section">
    <div class="container">
      <div class="album-hero">
        <div>
          <span class="badge">{formattedDate ?? 'Signature Series'}</span>
          <h1 class="section-title" style="margin-top: 1rem;">{albumTitle}</h1>
          <p class="section-subtitle" style="margin-top: 1rem;">
            {locationLabel} · {frameLabel}
          </p>
          <p style="margin-top: 1.5rem; color: var(--muted); max-width: 40rem;">
            {albumDescription}
          </p>
          {albumDate && (
            <p style="margin-top: 1.5rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.2em;">
              {albumDate.getUTCFullYear()}
            </p>
          )}
        </div>
        <img
          src={cfImageUrl(album.coverKey, { width: 1400, quality: 80 })}
          alt={`${albumTitle} cover`}
          loading="eager"
          decoding="async"
          fetchpriority="high"
          width="1400"
          height="933"
        />
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <!-- Responsive image grid with click-to-open lightbox -->
      <div class="image-grid">
        {album.imageKeys.map((image, index) => (
          <button
            type="button"
            data-lightbox-src={cfImageUrl(image, { width: 2000, quality: 82 })}
            aria-label={`Open image ${index + 1}`}
          >
            <img
              src={cfImageUrl(image, { width: 900, quality: 78 })}
              alt={`${albumTitle} image ${index + 1}`}
              loading="lazy"
              decoding="async"
              width="900"
              height="600"
            />
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Lightweight lightbox overlay (no external libraries) -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lightbox-content">
      <button type="button" id="lightbox-close">Close</button>
      <div class="lightbox-image-frame">
        <img
          id="lightbox-image"
          src=""
          alt="Expanded view"
          loading="lazy"
          decoding="async"
          width="2000"
          height="1333"
        />
      </div>
    </div>
  </div>

  <script is:inline>
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const closeButton = document.getElementById('lightbox-close');

    const openLightbox = (src) => {
      lightboxImage.src = src;
      lightbox.classList.add('is-open');
      lightbox.setAttribute('aria-hidden', 'false');
    };

    const closeLightbox = () => {
      lightbox.classList.remove('is-open');
      lightbox.setAttribute('aria-hidden', 'true');
      lightboxImage.src = '';
    };

    document.querySelectorAll('[data-lightbox-src]').forEach((button) => {
      button.addEventListener('click', () => {
        openLightbox(button.dataset.lightboxSrc);
      });
    });

    closeButton.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (event) => {
      if (event.target === lightbox) {
        closeLightbox();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeLightbox();
      }
    });
  </script>
</BaseLayout>
